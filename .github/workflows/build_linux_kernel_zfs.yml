name: Fast Build Linux Kernel + ZFS debs

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "选择要编译的内核主版本"
        required: true
        type: choice
        options:
          - "6.12"
          - "6.17"
        default: "6.12"
      zfs_ref:
        description: "OpenZFS 版本 (tag 或 commit)"
        required: true
        default: "zfs-2.3.0"
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential bc bison flex libncurses5-dev \
            libssl-dev libelf-dev dwarves fakeroot devscripts debhelper \
            curl jq xz-utils rsync ccache \
            autoconf automake libtool pkg-config gawk \
            dh-python dh-sequence-dkms \
            uuid-dev libblkid-dev libudev-dev zlib1g-dev \
            libaio-dev libcurl4-openssl-dev libpam0g-dev \
            libtirpc-dev libunwind-dev \
            python3-all-dev python3-cffi python3-setuptools python3-sphinx

      - name: Fetch latest patch version
        id: meta
        run: |
          kv="${{ github.event.inputs.kernel_version }}"
          curl -s https://www.kernel.org/releases.json > releases.json
          latest=$(jq -r ".releases[] | select(.version | startswith(\"$kv\")) | .version" releases.json | sort -V | tail -n1)
          echo "Latest patch for $kv is $latest"
          echo "kernel_version=$latest" >> $GITHUB_OUTPUT

      - name: Download kernel source
        run: |
          kv=${{ steps.meta.outputs.kernel_version }}
          curl -L "https://cdn.kernel.org/pub/linux/kernel/v${kv%%.*}.x/linux-${kv}.tar.xz" -o linux.tar.xz
          tar -xf linux.tar.xz
          mv "linux-${kv}" linux

      - name: Apply repo .config
        working-directory: linux
        run: |
          cp $GITHUB_WORKSPACE/.config .config
          yes "" | make olddefconfig

      - name: SSH connection to Actions
        uses: P3TERX/ssh2actions@v1.0.0
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}  
  
      - name: Build kernel debs
        working-directory: linux
        run: |
          make -j$(nproc) bindeb-pkg
          cd ..
          ls -la *.deb

      - name: Fetch OpenZFS
        run: |
          git clone https://github.com/openzfs/zfs.git
          cd zfs
          git checkout "${{ github.event.inputs.zfs_ref }}"
          ./autogen.sh

      - name: Configure ZFS against kernel source
        working-directory: zfs
        run: |
          KDIR="$GITHUB_WORKSPACE/linux"
          ./configure --with-linux="$KDIR" --with-linux-obj="$KDIR" --enable-systemd

      - name: Build ZFS native deb
        working-directory: zfs
        run: |
          sudo KVERS=${{ steps.meta.outputs.kernel_version }} \
          KSRC="$GITHUB_WORKSPACE/linux" \
          KOBJ="$GITHUB_WORKSPACE/linux" \
          make -j$(nproc) native-deb 
          ls -la ../*.deb

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-zfs-debs
          path: |
            linux/.config
            *.deb
